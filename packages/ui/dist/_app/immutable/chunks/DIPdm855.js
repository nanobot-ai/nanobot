import{C as V,I as X,aP as Re,O as U,E as b,au as ve,J as de,g as I,U as st,L as it,M as rt,N as Ie,P as M,F as R,ae as Ue,aI as at,al as Ee,y as $,aQ as P,D as J,H as nt,ac as Ce,a8 as ot,aG as ye,aR as Le,aS as lt,aT as ct,aU as ut,z as De,B as ze,aV as le,q as xe,aC as ge,aW as ft,aF as ht,A as K,K as je,aX as dt,aY as gt,Y as pt,as as We,aZ as vt,a_ as Ve,e as me,a$ as yt,b0 as mt,b1 as He,b2 as Je,b3 as bt,b4 as St,b5 as wt,b6 as _t,b7 as It,b8 as Et,b9 as Ct,ba as Tt,bb as At,aa as Nt,u as kt,r as Ot,p as Z,c as ee,i as $t,s as Pt,aO as te,j as Mt,f as se,h as Ye,bc as Ft,bd as Rt,be as Ut,a9 as N,ak as Te,ah as Ae,W as k,V as L}from"./-O1spnY-.js";import{g as Lt,i as Dt,j as q,k as zt,l as xt,d as jt,n as Wt,o as Vt,p as Ht,a as Y,c as ie}from"./DzEwUWT7.js";import{B as qe,p as D,r as re,s as be}from"./BuMt1Zx9.js";function Jt(t,e){return e}function Yt(t,e,s){for(var i=[],r=e.length,a,n=e.length,o=0;o<r;o++){let g=e[o];ze(g,()=>{if(a){if(a.pending.delete(g),a.done.add(g),a.pending.size===0){var f=t.outrogroups;pe(ye(a.done)),f.delete(a),f.size===0&&(t.outrogroups=null)}}else n-=1},!1)}if(n===0){var l=i.length===0&&s!==null;if(l){var h=s,c=h.parentNode;ht(c),c.append(h),t.items.clear()}pe(e,!l)}else a={pending:new Set(e),done:new Set},(t.outrogroups??=new Set).add(a)}function pe(t,e=!0){for(var s=0;s<t.length;s++)K(t[s],e)}var Ne;function qt(t,e,s,i,r,a=null){var n=t,o=new Map,l=(e&Re)!==0;if(l){var h=t;n=b?U(ve(h)):h.appendChild(V())}b&&de();var c=null,g=st(()=>{var d=s();return Le(d)?d:d==null?[]:ye(d)}),f,m=!0;function w(){u.fallback=c,Bt(u,f,n,e,i),c!==null&&(f.length===0?(c.f&P)===0?De(c):(c.f^=P,W(c,null,n)):ze(c,()=>{c=null}))}var E=X(()=>{f=I(g);var d=f.length;let T=!1;if(b){var A=it(n)===rt;A!==(d===0)&&(n=Ie(),U(n),M(!1),T=!0)}for(var S=new Set,O=$,y=nt(),p=0;p<d;p+=1){b&&R.nodeType===Ue&&R.data===at&&(n=R,T=!0,M(!1));var _=f[p],C=i(_,p),v=m?null:o.get(C);v?(v.v&&Ee(v.v,_),v.i&&Ee(v.i,p),y&&O.skipped_effects.delete(v.e)):(v=Kt(o,m?n:Ne??=V(),_,C,p,r,e,s),m||(v.e.f|=P),o.set(C,v)),S.add(C)}if(d===0&&a&&!c&&(m?c=J(()=>a(n)):(c=J(()=>a(Ne??=V())),c.f|=P)),b&&d>0&&U(Ie()),!m)if(y){for(const[ne,oe]of o)S.has(ne)||O.skipped_effects.add(oe.e);O.oncommit(w),O.ondiscard(()=>{})}else w();T&&M(!0),I(g)}),u={effect:E,items:o,outrogroups:null,fallback:c};m=!1,b&&(n=R)}function Bt(t,e,s,i,r){var a=(i&ft)!==0,n=e.length,o=t.items,l=t.effect.first,h,c=null,g,f=[],m=[],w,E,u,d;if(a)for(d=0;d<n;d+=1)w=e[d],E=r(w,d),u=o.get(E).e,(u.f&P)===0&&(u.nodes?.a?.measure(),(g??=new Set).add(u));for(d=0;d<n;d+=1){if(w=e[d],E=r(w,d),u=o.get(E).e,t.outrogroups!==null)for(const v of t.outrogroups)v.pending.delete(u),v.done.delete(u);if((u.f&P)!==0)if(u.f^=P,u===l)W(u,null,s);else{var T=c?c.next:l;u===t.effect.last&&(t.effect.last=u.prev),u.prev&&(u.prev.next=u.next),u.next&&(u.next.prev=u.prev),F(t,c,u),F(t,u,T),W(u,T,s),c=u,f=[],m=[],l=c.next;continue}if((u.f&le)!==0&&(De(u),a&&(u.nodes?.a?.unfix(),(g??=new Set).delete(u))),u!==l){if(h!==void 0&&h.has(u)){if(f.length<m.length){var A=m[0],S;c=A.prev;var O=f[0],y=f[f.length-1];for(S=0;S<f.length;S+=1)W(f[S],A,s);for(S=0;S<m.length;S+=1)h.delete(m[S]);F(t,O.prev,y.next),F(t,c,O),F(t,y,A),l=A,c=y,d-=1,f=[],m=[]}else h.delete(u),W(u,l,s),F(t,u.prev,u.next),F(t,u,c===null?t.effect.first:c.next),F(t,c,u),c=u;continue}for(f=[],m=[];l!==null&&l!==u;)(h??=new Set).add(l),m.push(l),l=l.next;if(l===null)continue}(u.f&P)===0&&f.push(u),c=u,l=u.next}if(t.outrogroups!==null){for(const v of t.outrogroups)v.pending.size===0&&(pe(ye(v.done)),t.outrogroups?.delete(v));t.outrogroups.size===0&&(t.outrogroups=null)}if(l!==null||h!==void 0){var p=[];if(h!==void 0)for(u of h)(u.f&le)===0&&p.push(u);for(;l!==null;)(l.f&le)===0&&l!==t.fallback&&p.push(l),l=l.next;var _=p.length;if(_>0){var C=(i&Re)!==0&&n===0?s:null;if(a){for(d=0;d<_;d+=1)p[d].nodes?.a?.measure();for(d=0;d<_;d+=1)p[d].nodes?.a?.fix()}Yt(t,p,C)}}a&&xe(()=>{if(g!==void 0)for(u of g)u.nodes?.a?.apply()})}function Kt(t,e,s,i,r,a,n,o){var l=(n&lt)!==0?(n&ct)===0?ot(s,!1,!1):Ce(s):null,h=(n&ut)!==0?Ce(r):null;return{v:l,i:h,e:J(()=>(a(e,l??s,h??r,o),()=>{t.delete(i)}))}}function W(t,e,s){if(t.nodes)for(var i=t.nodes.start,r=t.nodes.end,a=e&&(e.f&P)===0?e.nodes.start:s;i!==null;){var n=ge(i);if(a.before(i),i===r)return;i=n}}function F(t,e,s){e===null?t.effect.first=s:e.next=s,s===null?t.effect.last=e:s.prev=e}function ae(t,e,...s){var i=new qe(t);X(()=>{const r=e()??null;i.ensure(r,r&&(a=>r(a,...s)))},je)}function Gt(t,e,s,i,r,a){let n=b;b&&de();var o=null;b&&R.nodeType===dt&&(o=R,de());var l=b?R:t,h=new qe(l,!1);X(()=>{const c=e()||null;var g=gt;if(c===null){h.ensure(null,null),q(!0);return}return h.ensure(c,f=>{if(c){if(o=b?o:document.createElementNS(g,c),Lt(o,o),i){b&&Dt(c)&&o.append(document.createComment(""));var m=b?ve(o):o.appendChild(V());b&&(m===null?M(!1):U(m)),i(o,m)}pt.nodes.end=o,f.before(o)}b&&U(f)}),q(!0),()=>{c&&q(!1)}},je),We(()=>{q(!0)}),n&&(M(!0),U(l))}function ps(t,e){let s=null,i=b;var r;if(b){s=R;for(var a=ve(document.head);a!==null&&(a.nodeType!==Ue||a.data!==t);)a=ge(a);if(a===null)M(!1);else{var n=ge(a);a.remove(),U(n)}}b||(r=document.head.appendChild(V()));try{X(()=>e(r),vt)}finally{i&&(M(!0),U(s))}}function Qt(t,e){var s=void 0,i;Ve(()=>{s!==(s=e())&&(i&&(K(i),i=null),s&&(i=J(()=>{me(()=>s(t))})))})}function Be(t){var e,s,i="";if(typeof t=="string"||typeof t=="number")i+=t;else if(typeof t=="object")if(Array.isArray(t)){var r=t.length;for(e=0;e<r;e++)t[e]&&(s=Be(t[e]))&&(i&&(i+=" "),i+=s)}else for(s in t)t[s]&&(i&&(i+=" "),i+=s);return i}function Xt(){for(var t,e,s=0,i="",r=arguments.length;s<r;s++)(t=arguments[s])&&(e=Be(t))&&(i&&(i+=" "),i+=e);return i}function Zt(t){return typeof t=="object"?Xt(t):t??""}const ke=[...` 	
\r\fÂ \v\uFEFF`];function es(t,e,s){var i=t==null?"":""+t;if(s){for(var r in s)if(s[r])i=i?i+" "+r:r;else if(i.length)for(var a=r.length,n=0;(n=i.indexOf(r,n))>=0;){var o=n+a;(n===0||ke.includes(i[n-1]))&&(o===i.length||ke.includes(i[o]))?i=(n===0?"":i.substring(0,n))+i.substring(o+1):n=o}}return i===""?null:i}function Oe(t,e=!1){var s=e?" !important;":";",i="";for(var r in t){var a=t[r];a!=null&&a!==""&&(i+=" "+r+": "+a+s)}return i}function ce(t){return t[0]!=="-"||t[1]!=="-"?t.toLowerCase():t}function ts(t,e){if(e){var s="",i,r;if(Array.isArray(e)?(i=e[0],r=e[1]):i=e,t){t=String(t).replaceAll(/\s*\/\*.*?\*\/\s*/g,"").trim();var a=!1,n=0,o=!1,l=[];i&&l.push(...Object.keys(i).map(ce)),r&&l.push(...Object.keys(r).map(ce));var h=0,c=-1;const E=t.length;for(var g=0;g<E;g++){var f=t[g];if(o?f==="/"&&t[g-1]==="*"&&(o=!1):a?a===f&&(a=!1):f==="/"&&t[g+1]==="*"?o=!0:f==='"'||f==="'"?a=f:f==="("?n++:f===")"&&n--,!o&&a===!1&&n===0){if(f===":"&&c===-1)c=g;else if(f===";"||g===E-1){if(c!==-1){var m=ce(t.substring(h,c).trim());if(!l.includes(m)){f!==";"&&g++;var w=t.substring(h,g).trim();s+=" "+w+";"}}h=g+1,c=-1}}}}return i&&(s+=Oe(i)),r&&(s+=Oe(r,!0)),s=s.trim(),s===""?null:s}return t==null?null:String(t)}function ss(t,e,s,i,r,a){var n=t.__className;if(b||n!==s||n===void 0){var o=es(s,i,a);(!b||o!==t.getAttribute("class"))&&(o==null?t.removeAttribute("class"):e?t.className=o:t.setAttribute("class",o)),t.__className=s}else if(a&&r!==a)for(var l in a){var h=!!a[l];(r==null||h!==!!r[l])&&t.classList.toggle(l,h)}return a}function ue(t,e={},s,i){for(var r in s){var a=s[r];e[r]!==a&&(s[r]==null?t.style.removeProperty(r):t.style.setProperty(r,a,i))}}function is(t,e,s,i){var r=t.__style;if(b||r!==e){var a=ts(e,i);(!b||a!==t.getAttribute("style"))&&(a==null?t.removeAttribute("style"):t.style.cssText=a),t.__style=e}else i&&(Array.isArray(i)?(ue(t,s?.[0],i[0]),ue(t,s?.[1],i[1],"important")):ue(t,s,i));return i}function G(t,e,s=!1){if(t.multiple){if(e==null)return;if(!Le(e))return yt();for(var i of t.options)i.selected=e.includes(H(i));return}for(i of t.options){var r=H(i);if(mt(r,e)){i.selected=!0;return}}(!s||e!==void 0)&&(t.selectedIndex=-1)}function Ke(t){var e=new MutationObserver(()=>{G(t,t.__value)});e.observe(t,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),We(()=>{e.disconnect()})}function vs(t,e,s=e){var i=new WeakSet,r=!0;He(t,"change",a=>{var n=a?"[selected]":":checked",o;if(t.multiple)o=[].map.call(t.querySelectorAll(n),H);else{var l=t.querySelector(n)??t.querySelector("option:not([disabled])");o=l&&H(l)}s(o),$!==null&&i.add($)}),me(()=>{var a=e();if(t===document.activeElement){var n=Je??$;if(i.has(n))return}if(G(t,a,r),r&&a===void 0){var o=t.querySelector(":checked");o!==null&&(a=H(o),s(a))}t.__value=a,r=!1}),Ke(t)}function H(t){return"__value"in t?t.__value:t.value}const z=Symbol("class"),x=Symbol("style"),Ge=Symbol("is custom element"),Qe=Symbol("is html");function rs(t){if(b){var e=!1,s=()=>{if(!e){if(e=!0,t.hasAttribute("value")){var i=t.value;Q(t,"value",null),t.value=i}if(t.hasAttribute("checked")){var r=t.checked;Q(t,"checked",null),t.checked=r}}};t.__on_r=s,xe(s),At()}}function ys(t,e){var s=Se(t);s.checked!==(s.checked=e??void 0)&&(t.checked=e)}function as(t,e){e?t.hasAttribute("selected")||t.setAttribute("selected",""):t.removeAttribute("selected")}function Q(t,e,s,i){var r=Se(t);b&&(r[e]=t.getAttribute(e),e==="src"||e==="srcset"||e==="href"&&t.nodeName==="LINK")||r[e]!==(r[e]=s)&&(e==="loading"&&(t[St]=s),s==null?t.removeAttribute(e):typeof s!="string"&&Xe(t).includes(e)?t[e]=s:t.setAttribute(e,s))}function ns(t,e,s,i,r=!1,a=!1){if(b&&r&&t.tagName==="INPUT"){var n=t,o=n.type==="checkbox"?"defaultChecked":"defaultValue";o in s||rs(n)}var l=Se(t),h=l[Ge],c=!l[Qe];let g=b&&h;g&&M(!1);var f=e||{},m=t.tagName==="OPTION";for(var w in e)w in s||(s[w]=null);s.class?s.class=Zt(s.class):s[z]&&(s.class=null),s[x]&&(s.style??=null);var E=Xe(t);for(const y in s){let p=s[y];if(m&&y==="value"&&p==null){t.value=t.__value="",f[y]=p;continue}if(y==="class"){var u=t.namespaceURI==="http://www.w3.org/1999/xhtml";ss(t,u,p,i,e?.[z],s[z]),f[y]=p,f[z]=s[z];continue}if(y==="style"){is(t,p,e?.[x],s[x]),f[y]=p,f[x]=s[x];continue}var d=f[y];if(!(p===d&&!(p===void 0&&t.hasAttribute(y)))){f[y]=p;var T=y[0]+y[1];if(T!=="$$")if(T==="on"){const _={},C="$$"+y;let v=y.slice(2);var A=Vt(v);if(zt(v)&&(v=v.slice(0,-7),_.capture=!0),!A&&d){if(p!=null)continue;t.removeEventListener(v,f[C],_),f[C]=null}if(p!=null)if(A)t[`__${v}`]=p,jt([v]);else{let ne=function(oe){f[y].call(this,oe)};f[C]=xt(v,t,ne,_)}else A&&(t[`__${v}`]=void 0)}else if(y==="style")Q(t,y,p);else if(y==="autofocus")Ct(t,!!p);else if(!h&&(y==="__value"||y==="value"&&p!=null))t.value=t.__value=p;else if(y==="selected"&&m)as(t,p);else{var S=y;c||(S=Wt(S));var O=S==="defaultValue"||S==="defaultChecked";if(p==null&&!h&&!O)if(l[y]=null,S==="value"||S==="checked"){let _=t;const C=e===void 0;if(S==="value"){let v=_.defaultValue;_.removeAttribute(S),_.defaultValue=v,_.value=_.__value=C?v:null}else{let v=_.defaultChecked;_.removeAttribute(S),_.defaultChecked=v,_.checked=C?v:!1}}else t.removeAttribute(y);else O||E.includes(S)&&(h||typeof p!="string")?(t[S]=p,S in l&&(l[S]=Tt)):typeof p!="function"&&Q(t,S,p)}}}return g&&M(!0),f}function $e(t,e,s=[],i=[],r=[],a,n=!1,o=!1){bt(r,s,i,l=>{var h=void 0,c={},g=t.nodeName==="SELECT",f=!1;if(Ve(()=>{var w=e(...l.map(I)),E=ns(t,h,w,a,n,o);f&&g&&"value"in w&&G(t,w.value);for(let d of Object.getOwnPropertySymbols(c))w[d]||K(c[d]);for(let d of Object.getOwnPropertySymbols(w)){var u=w[d];d.description===It&&(!h||u!==h[d])&&(c[d]&&K(c[d]),c[d]=J(()=>Qt(t,()=>u))),E[d]=u}h=E}),g){var m=t;me(()=>{G(m,h.value,!0),Ke(m)})}f=!0})}function Se(t){return t.__attributes??={[Ge]:t.nodeName.includes("-"),[Qe]:t.namespaceURI===wt}}var Pe=new Map;function Xe(t){var e=t.getAttribute("is")||t.nodeName,s=Pe.get(e);if(s)return s;Pe.set(e,s=[]);for(var i,r=t,a=Element.prototype;a!==r;){i=Et(r);for(var n in i)i[n].set&&s.push(n);r=_t(r)}return s}function ms(t,e,s=e){var i=new WeakSet;He(t,"input",async r=>{var a=r?t.defaultValue:t.value;if(a=fe(t)?he(a):a,s(a),$!==null&&i.add($),await Nt(),a!==(a=e())){var n=t.selectionStart,o=t.selectionEnd,l=t.value.length;if(t.value=a??"",o!==null){var h=t.value.length;n===o&&o===l&&h>l?(t.selectionStart=h,t.selectionEnd=h):(t.selectionStart=n,t.selectionEnd=Math.min(o,h))}}}),(b&&t.defaultValue!==t.value||kt(e)==null&&t.value)&&(s(fe(t)?he(t.value):t.value),$!==null&&i.add($)),Ot(()=>{var r=e();if(t===document.activeElement){var a=Je??$;if(i.has(a))return}fe(t)&&r===he(t.value)||t.type==="date"&&!r&&!t.value||r!==t.value&&(t.value=r??"")})}function fe(t){var e=t.type;return e==="number"||e==="range"}function he(t){return t===""?null:+t}const os={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":2,"stroke-linecap":"round","stroke-linejoin":"round"};var ls=Ht("<svg><!><!></svg>");function we(t,e){Z(e,!0);const s=D(e,"color",3,"currentColor"),i=D(e,"size",3,24),r=D(e,"strokeWidth",3,2),a=D(e,"absoluteStrokeWidth",3,!1),n=D(e,"iconNode",19,()=>[]),o=re(e,["$$slots","$$events","$$legacy","name","color","size","strokeWidth","absoluteStrokeWidth","iconNode","children"]);var l=ls();$e(l,g=>({...os,...o,width:i(),height:i(),stroke:s(),"stroke-width":g,class:["lucide-icon lucide",e.name&&`lucide-${e.name}`,e.class]}),[()=>a()?Number(r())*24/Number(i()):r()]);var h=$t(l);qt(h,17,n,Jt,(g,f)=>{var m=Ye(()=>Ft(I(f),2));let w=()=>I(m)[0],E=()=>I(m)[1];var u=ie(),d=se(u);Gt(d,w,!0,(T,A)=>{$e(T,()=>({...E()}))}),Y(g,u)});var c=Pt(h);ae(c,()=>e.children??te),Mt(l),Y(t,l),ee()}function bs(t,e){Z(e,!0);let s=re(e,["$$slots","$$events","$$legacy"]);const i=[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"}]];we(t,be({name:"copy"},()=>s,{get iconNode(){return i},children:(r,a)=>{var n=ie(),o=se(n);ae(o,()=>e.children??te),Y(r,n)},$$slots:{default:!0}})),ee()}function Ss(t,e){Z(e,!0);let s=re(e,["$$slots","$$events","$$legacy"]);const i=[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3"}],["path",{d:"M12 9v4"}],["path",{d:"M12 17h.01"}]];we(t,be({name:"triangle-alert"},()=>s,{get iconNode(){return i},children:(r,a)=>{var n=ie(),o=se(n);ae(o,()=>e.children??te),Y(r,n)},$$slots:{default:!0}})),ee()}function ws(t,e){Z(e,!0);let s=re(e,["$$slots","$$events","$$legacy"]);const i=[["path",{d:"M18 6 6 18"}],["path",{d:"m6 6 12 12"}]];we(t,be({name:"x"},()=>s,{get iconNode(){return i},children:(r,a)=>{var n=ie(),o=se(n);ae(o,()=>e.children??te),Y(r,n)},$$slots:{default:!0}})),ee()}const Ze=Symbol("notifications");function _s(t){Ut(Ze,t)}function et(){return Rt(Ze)}const cs="/mcp?ui";function j(t){try{et().error("API Error",t?.toString())}catch{console.error("MCP Tool Error:",t)}console.error("Error:",t)}class Me{#e;#i;#s;#a;#n;#o;#t;#r=new Map;constructor(e){const s=e?.baseUrl||"",i=e?.path||cs;if(this.#e=`${s}${i}`,this.#i=e?.fetcher||fetch,e?.sessionId)this.#s=e.sessionId==="new"?void 0:e.sessionId,this.#o=!0;else{const r=this.#l();r&&(this.#s=r.sessionId,this.#a=r.initializeResult),this.#o=!1}}async deleteSession(){try{if(!this.#s)return;await this.#i(this.#e,{method:"DELETE",headers:{"Mcp-Session-Id":this.#s}})}finally{this.#f()}}#l(){if(typeof window>"u"||typeof localStorage>"u")return;const e=localStorage.getItem(`mcp-session-${this.#e}`);if(e)try{return JSON.parse(e)}catch(s){console.error("[SimpleClient] Failed to parse stored session:",s);return}}#c(e,s){if(typeof window>"u"||typeof localStorage>"u")return;const i={sessionId:e,initializeResult:s};localStorage.setItem(`mcp-session-${this.#e}`,JSON.stringify(i))}#f(){typeof window>"u"||typeof localStorage>"u"||(localStorage.removeItem(`mcp-session-${this.#e}`),this.#s=void 0,this.#a=void 0,this.#t&&(this.#t.close(),this.#t=void 0),this.#r.clear())}async getSessionDetails(){return{id:await this.#u(),initializeResult:this.#a}}async#h(){return this.#n?this.#n:(this.#n=(async()=>{try{const e={jsonrpc:"2.0",id:crypto.randomUUID(),method:"initialize",params:{protocolVersion:"2024-11-05",capabilities:{},clientInfo:{name:"nanobot-ui",version:"0.0.1"}}},s=await this.#i(this.#e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!s.ok)throw new Error(`Initialize failed: ${s.status} ${s.statusText}`);const i=s.headers.get("Mcp-Session-Id");if(!i)throw new Error("No Mcp-Session-Id header in initialize response");const r=await s.json();if(r.error)throw new Error(`Initialize error: ${r.error.message}`);this.#s=i,this.#a=r.result,this.#o||this.#c(i,this.#a);const a={jsonrpc:"2.0",id:crypto.randomUUID(),method:"notifications/initialized",params:{}},n=await this.#i(this.#e,{method:"POST",headers:{"Content-Type":"application/json","Mcp-Session-Id":i},body:JSON.stringify(a)});if(!n.ok)throw new Error(`Initialized notification failed: ${n.status} ${n.statusText}`)}finally{this.#n=void 0}})(),this.#n)}async#u(){if(this.#s||await this.#h(),!this.#s)throw new Error("Failed to establish session");return this.#s}async reply(e,s){const i=await this.#u(),r=await this.#i(this.#e,{method:"POST",headers:{"Content-Type":"application/json","Mcp-Session-Id":i},body:JSON.stringify({jsonrpc:"2.0",id:e,result:s})});if(!(r.status===204||r.status===202)){if(!r.ok){const a=await r.text();throw j(`reply: ${r.status}: ${r.statusText}: ${a}`),new Error(a)}try{const a=await r.json();if(a.error?.message)throw j(a.error.message),new Error(a.error.message)}catch(a){if(a instanceof Error&&a.message!=="Unexpected end of JSON input")throw a;console.debug("[SimpleClient] Error parsing JSON in reply:",a)}}}async exchange(e,s,i){const r=await this.#u(),a={jsonrpc:"2.0",id:crypto.randomUUID(),method:e,params:s},[n,o]=this.#e.split("?"),l=new URLSearchParams(o||"");l.set("method",e),e==="tools/call"&&s&&typeof s=="object"&&"name"in s&&l.set("toolcallname",String(s.name));const h=`${n}?${l.toString()}`,c=await this.#i(h,{method:"POST",headers:{"Content-Type":"application/json","Mcp-Session-Id":r},signal:i?.abort?.signal,body:JSON.stringify(a)});if(c.status===404){if(this.#o)throw new Error("Session not found (404). External sessions cannot be recreated.");return this.#f(),this.exchange(e,s,{abort:i?.abort})}if(!c.ok){const f=await c.text();throw j(`exchange: ${c.status}: ${c.statusText}: ${f}`),new Error(f)}const g=await c.json();if(g.error)throw j(g.error.message),new Error(g.error.message);return g.result}async callMCPTool(e,s){const i=await this.exchange("tools/call",{name:e,arguments:s?.payload||{},...s?.async&&{_meta:{"ai.nanobot.async":!0,progressToken:s?.progressToken}}},{abort:s?.abort});return i&&typeof i=="object"&&"structuredContent"in i?i.structuredContent:i}async listResources(e){const s=await this.exchange("resources/list",{...e?.prefix&&{_meta:{"ai.nanobot":{prefix:e.prefix}}}},{abort:e?.abort});return e?.prefix?{...s,resources:s.resources.filter(({name:i})=>e?.prefix&&i.startsWith(e.prefix))}:s}async#d(){if(this.#t&&this.#t.readyState!==EventSource.CLOSED)return;await this.#u();const[e,s]=this.#e.split("?"),i=new URLSearchParams(s||"");i.set("stream","true");const r=`${e}?${i.toString()}`;this.#t=new EventSource(r),this.#t.onmessage=a=>{try{const n=JSON.parse(a.data);if(n.method==="notifications/resources/updated"&&n.params?.uri){const o=n.params.uri;for(const[l,h]of this.#r.entries())o.startsWith(l)&&this.#g(o).then(c=>{c&&h.forEach(g=>g(c))})}}catch(n){console.error("[SimpleClient] Failed to parse SSE message:",n)}},this.#t.onerror=a=>{console.error("[SimpleClient] SSE connection error:",a)},this.#t.onopen=()=>{console.log("[SimpleClient] SSE connection established")}}async#g(e){try{const s=await this.exchange("resources/read",{uri:e});if(s.resources?.length)return s.resources[0]}catch(s){j(`[SimpleClient] Failed to fetch resource ${e}: ${s instanceof Error?s.message:String(s)}`)}return null}watchResource(e,s){return this.#r.has(e)||this.#r.set(e,new Set),this.#r.get(e).add(s),this.#d().then(async()=>{try{await this.exchange("resources/subscribe",{uri:e}),console.log(`[SimpleClient] Subscribed to resources with prefix: ${e}`)}catch(i){console.error(`[SimpleClient] Failed to subscribe to ${e}:`,i)}}),()=>{const i=this.#r.get(e);i&&(i.delete(s),i.size===0&&(this.#r.delete(e),this.exchange("resources/unsubscribe",{uri:e}).catch(r=>{console.error(`[SimpleClient] Failed to unsubscribe from ${e}:`,r)}))),console.log(`[SimpleClient] Stopped watching resources with prefix: ${e}`),this.#r.size===0&&this.#t&&(this.#t.close(),this.#t=void 0)}}}var Fe=!1;class _e extends Date{#e=N(super.getTime());#i=new Map;#s=Te;constructor(...e){super(...e),Fe||this.#a()}#a(){Fe=!0;var e=_e.prototype,s=Date.prototype,i=Object.getOwnPropertyNames(s);for(const r of i)(r.startsWith("get")||r.startsWith("to")||r==="valueOf")&&(e[r]=function(...a){if(a.length>0)return I(this.#e),s[r].apply(this,a);var n=this.#i.get(r);if(n===void 0){const o=Te;Ae(this.#s),n=Ye(()=>(I(this.#e),s[r].apply(this,a))),this.#i.set(r,n),Ae(o)}return I(n)}),r.startsWith("set")&&(e[r]=function(...a){var n=s[r].apply(this,a);return k(this.#e,s.getTime.call(this)),n})}}class us{baseUrl;mcpClient;constructor(e="",s){this.baseUrl=e,this.mcpClient=new Me({baseUrl:e,fetcher:s?.fetcher,sessionId:s?.sessionId})}#e(e){return e?new Me({baseUrl:this.baseUrl,sessionId:e}):this.mcpClient}async reply(e,s,i){await this.#e(i?.sessionId).reply(e,s)}async exchange(e,s,i){return await this.#e(i?.sessionId).exchange(e,s)}async callMCPTool(e,s){const i=this.#e(s?.sessionId);try{const r=await i.exchange("tools/call",{name:e,arguments:s?.payload||{},...s?.async&&{_meta:{"ai.nanobot.async":!0,progressToken:s?.progressToken}}},{abort:s?.abort});return s?.parseResponse?s.parseResponse(r):r&&typeof r=="object"&&"structuredContent"in r?r.structuredContent:r}catch(r){try{const a=et(),n=r instanceof Error?r.message:String(r);a.error("API Error",n)}catch{console.error("MCP Tool Error:",r)}throw r}}async capabilities(){const e=this.#e(),{initializeResult:s}=await e.getSessionDetails();return s?.capabilities?.experimental?.["ai.nanobot"]?.session??{}}async deleteThread(e){return this.#e(e).deleteSession()}async renameThread(e,s){return await this.callMCPTool("update_chat",{payload:{chatId:e,title:s}})}async listAgents(e){return await this.callMCPTool("list_agents",e)}async getThreads(){return(await this.callMCPTool("list_chats")).chats}async createThread(){const e=this.#e("new"),{id:s}=await e.getSessionDetails();return{id:s,title:"New Chat",created:new _e().toISOString()}}async createResource(e,s,i,r){return await this.callMCPTool("create_resource",{payload:{blob:i,mimeType:s,name:e,...r?.description&&{description:r.description}},sessionId:r?.sessionId,abort:r?.abort,parseResponse:a=>a.content?.[0]?.type==="resource_link"?{uri:a.content[0].uri}:{uri:""}})}async sendMessage(e){return await this.callMCPTool("chat",{payload:{prompt:e.message,attachments:e.attachments?.map(i=>({name:i.name,url:i.uri,mimeType:i.mimeType}))},sessionId:e.threadId,progressToken:e.id,async:!0}),{message:{id:e.id,role:"user",created:tt(),items:[{id:e.id+"_0",type:"text",text:e.message}]}}}subscribe(e,s,i){console.log("Subscribing to thread:",e);const r=new EventSource(`${this.baseUrl}/api/events/${e}`);r.onmessage=a=>{const n=JSON.parse(a.data);s({type:"message",message:n})};for(const a of i?.events??[])r.addEventListener(a,n=>{const o=parseInt(n.lastEventId);s({id:o||n.lastEventId,type:a,data:JSON.parse(n.data)})});return r.onerror=a=>{s({type:"error",error:String(a)}),console.error("EventSource failed:",a),r.close()},r.onopen=()=>{console.log("EventSource connected for thread:",e)},()=>r.close()}}function B(t,e){let s=!1;return e.id&&(t=t.map(i=>i.id===e.id?(s=!0,e):i)),s||(t=[...t,e]),t}const fs=new us;class Is{#e;get messages(){return I(this.#e)}set messages(e){k(this.#e,e,!0)}#i;get history(){return I(this.#i)}set history(e){k(this.#i,e,!0)}#s;get isLoading(){return I(this.#s)}set isLoading(e){k(this.#s,e,!0)}#a;get elicitations(){return I(this.#a)}set elicitations(e){k(this.#a,e,!0)}#n;get prompts(){return I(this.#n)}set prompts(e){k(this.#n,e,!0)}#o;get resources(){return I(this.#o)}set resources(e){k(this.#o,e,!0)}#t;get chatId(){return I(this.#t)}set chatId(e){k(this.#t,e,!0)}#r;get agent(){return I(this.#r)}set agent(e){k(this.#r,e,!0)}#l;get uploadedFiles(){return I(this.#l)}set uploadedFiles(e){k(this.#l,e,!0)}#c;get uploadingFiles(){return I(this.#c)}set uploadingFiles(e){k(this.#c,e,!0)}api;closer=()=>{};onChatDone=[];constructor(e){this.api=e?.api||fs,this.#e=N(L([])),this.#i=N(),this.#s=N(!1),this.#a=N(L([])),this.#n=N(L([])),this.#o=N(L([])),this.#t=N(""),this.#r=N(L({})),this.#l=N(L([])),this.#c=N(L([])),this.setChatId(e?.chatId)}close=()=>{this.closer(),this.setChatId("")};setChatId=async e=>{e!==this.chatId&&(this.messages=[],this.prompts=[],this.resources=[],this.elicitations=[],this.history=void 0,this.isLoading=!1,this.uploadedFiles=[],this.uploadingFiles=[],e&&(this.chatId=e,this.subscribe(e)),this.listResources().then(s=>{s&&s.resources&&(this.resources=s.resources)}),this.listPrompts().then(s=>{s&&s.prompts&&(this.prompts=s.prompts)}),await this.reloadAgent())};reloadAgent=async()=>{const e=await this.api.listAgents({sessionId:this.chatId});e.agents?.length>0&&(this.agent=e.agents[0])};listPrompts=async()=>await this.api.exchange("prompts/list",{},{sessionId:this.chatId});listResources=async()=>await this.api.exchange("resources/list",{},{sessionId:this.chatId});subscribe(e){this.closer(),e&&(this.closer=this.api.subscribe(e,s=>{if(s.type=="message"&&s.message?.id)this.history?this.history=B(this.history,s.message):this.messages=B(this.messages,s.message);else if(s.type=="history-start")this.history=[];else if(s.type=="history-end")this.messages=this.history||[],this.history=void 0;else if(s.type=="chat-in-progress")this.isLoading=!0;else if(s.type=="chat-done"){this.isLoading=!1;for(const i of this.onChatDone)i();this.onChatDone=[]}else s.type=="elicitation/create"&&(this.elicitations=[...this.elicitations,{id:s.id,...s.data}]);console.debug("Received event:",s)},{events:["history-start","history-end","chat-in-progress","chat-done","elicitation/create"]}))}replyToElicitation=async(e,s)=>{await this.api.reply(e.id,s,{sessionId:this.chatId}),this.elicitations=this.elicitations.filter(i=>i.id!==e.id)};newChat=async()=>{const e=await this.api.createThread();await this.setChatId(e.id)};sendMessage=async(e,s)=>{if(!(!e.trim()||this.isLoading)){this.isLoading=!0,this.chatId||await this.newChat();try{const i=await this.api.sendMessage({id:crypto.randomUUID(),threadId:this.chatId,message:e,attachments:[...this.uploadedFiles,...s||[]]});return this.uploadedFiles=[],this.messages=B(this.messages,i.message),new Promise(r=>{this.onChatDone.push(()=>{this.isLoading=!1;const a=this.messages.findIndex(n=>n.id===i.message.id);a!==-1&&a<=this.messages.length?r({message:this.messages[a+1]}):r()})})}catch(i){this.isLoading=!1,this.messages=B(this.messages,{id:crypto.randomUUID(),role:"assistant",created:tt(),items:[{id:crypto.randomUUID(),type:"text",text:`Sorry, I couldn't send your message. Please try again. Error: ${i}`}]})}}};cancelUpload=e=>{this.uploadingFiles=this.uploadingFiles.filter(s=>s.id!==e?!0:(s.controller&&s.controller.abort(),!1)),this.uploadedFiles=this.uploadedFiles.filter(s=>s.id!==e)};uploadFile=async(e,s)=>{if(!this.chatId){const a=await this.api.createThread();await this.setChatId(a.id)}const i=crypto.randomUUID(),r=s?.controller||new AbortController;this.uploadingFiles.push({file:e,id:i,controller:r});try{const a=await this.doUploadFile(e,r);return this.uploadedFiles.push({file:e,uri:a.uri,id:i,mimeType:a.mimeType}),a}finally{this.uploadingFiles=this.uploadingFiles.filter(a=>a.id!==i)}};doUploadFile=async(e,s)=>{const i=new FileReader;i.readAsDataURL(e),await new Promise((a,n)=>{i.onloadend=a,i.onerror=n});const r=i.result.split(",")[1];if(!this.chatId)throw new Error("Chat ID not set");return await this.api.createResource(e.name,e.type,r,{description:e.name,sessionId:this.chatId,abort:s})}}function tt(){return new Date().toISOString()}export{Is as C,we as I,_e as S,Ss as T,ws as X,bs as a,ms as b,ss as c,is as d,qt as e,_s as f,et as g,ps as h,Jt as i,fs as j,Q as k,Zt as l,vs as m,ys as n,rs as r,ae as s};
